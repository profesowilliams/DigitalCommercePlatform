<!-- @format -->

<script type="text/javascript">
    const redirectBasedOnCountry = (userData) => {
        let currentUserData = userData;

        if (currentUserData?.country) {
            let countryCodeFromAPI = '/' + currentUserData?.country.toLowerCase() + '/' + currentUserData?.language.toLowerCase();
            if (window.location.href.toLowerCase().indexOf(countryCodeFromAPI.toLowerCase()) < 0) {
                validateCountryFromUrlAndAPI(countryCodeFromAPI);
            }
        }
    }

    const validateCountryFromUrlAndAPI = (countryCodeFromAPI) => {
        let infoFromUrl = getHeaderInfoFromUrl(window.location.pathname);
        let countryCodeFromUrl = '/' + infoFromUrl.site + '/' + infoFromUrl.language;
        performRedirect(countryCodeFromUrl, countryCodeFromAPI);
    }

    const performRedirect = (countryCodeFromUrl, countryCodeFromAPI) => {
        if (countryCodeFromAPI.toLowerCase().indexOf(countryCodeFromUrl.toLowerCase()) < 0) {
            let resultantRedirectUrl = window.location.href.toLowerCase().replace(countryCodeFromUrl.toLowerCase(), countryCodeFromAPI);
            window.location.href = resultantRedirectUrl;
        }
    }

    (async function () {
        const [userIsLoggedIn, userData] = await getSessionInfo();
        let authorMode = !(typeof typeof Granite === 'undefined' || typeof Granite.author === 'undefined');
        if (authorMode) {
            document.getElementById('${page.id @ context="scriptString"}').style.display = "block";
            return;
        }

        // handle country redirection
        redirectBasedOnCountry(userData);

        if (userIsLoggedIn && userData) {
            document.getElementById('${page.id @ context="scriptString"}').style.display = "block";
        }
    })();
</script>
