parameters:
- name: projectSources  
  default: '**/*.csproj'
- name: unitTestSources
  default: '**/*Tests.csproj'
- name: projectKey  
  default: 'DC-DF-Core-*'
- name: projectName  
  default: 'DC-DF-Core-*'


steps:
#.NET 6
- task: UseDotNet@2
  displayName: Use .NET 6.x
  inputs:
    packageType: 'sdk'
    version: '6.x'
    
- task: DotNetCoreCLI@2
  displayName: 'Restore Packages'
  inputs:
    command: 'restore'
    projects: ${{ parameters.projectSources }}
    feedsToUse: 'select'
    vstsFeed: 'c1db23e3-14aa-4e9a-9464-1e9b795ce2b3'

- task: copyrightheader@1
  displayName: 'Copyrights Header check'
  inputs:
    headerRegex: '^[/\\\-<>!*\n]*\d{4} \(c\) ((Tech Data Corporation){1}|(TD Synnex){1}).*All Rights Reserved.*[/\\\-<>!*\n]*$'
    header: 'yyyy (c) Tech Data Corporation -. All Rights Reserved.'
    fileExtensions: '.cs,.sql'
    verbosity: 'detailed'
  env:
    SYSTEM_ACCESSTOKEN: $(system.accesstoken)    

- task: SonarQubePrepare@4
  displayName: 'Prepare analysis on SonarQube'
  continueOnError: true   
  inputs:
    SonarQube: 'DC-SonarQube'
    projectKey: ${{ parameters.projectKey }} 
    projectName: ${{ parameters.projectName }}
    extraProperties: |
      sonar.ws.timeout=60

- task: DotNetCoreCLI@2
  displayName: 'Build Projects'
  inputs:
    command: 'build'
    projects: ${{ parameters.projectSources }}
    arguments: '--configuration Debug --no-restore' 

- task: DotNetCoreCLI@2
  displayName: 'Run Unit Tests'
  inputs:
    command: 'test'
    projects: ${{ parameters.unitTestSources }}
    arguments: '--configuration Debug --no-restore --collect "Code coverage"'

- task: SonarQubeAnalyze@4
  displayName: 'Run Code Analysis'
  continueOnError: true
  inputs:
    extraProperties: |
      sonar.ws.timeout=600

- task: ms-omex.prmetrics.prmetrics.PRMetrics@1
  displayName: 'PR Metrics'
  inputs:
    BaseSize: 200
    GrowthRate: 2.0
    TestFactor: 0.7
    FileMatchingPatterns: |
      **/*
      !Ignore.cs
    CodeFileExtensions: |
      cs
      ps1
  continueOnError: true       
  env:
    SYSTEM_ACCESSTOKEN: $(system.accesstoken)       