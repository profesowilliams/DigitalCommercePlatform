parameters:
- name: pomFile  
  default: 'content/tds-site/pom.xml'
- name: projectKey  
  default: 'DC-AEM-*'
- name: projectName  
  default: 'DC-AEM-*'
- name: sonarExclusions  
  default: ''

variables:
- group: DF-GateBuilds
- name: Agent.Source.Git.ShallowFetchDepth
  value: 0

steps:
- task: SonarCloudPrepare@1
  displayName: 'Prepare analysis on SonarCloud'
  continueOnError: true   
  inputs:
    SonarCloud: 'DC-SonarCloud'
    organization: 'techdatacorp'
    projectKey: ${{ parameters.projectKey }} 
    projectName: ${{ parameters.projectName }}
    extraProperties: |
      sonar.ws.timeout=60
      sonar.exclusions=${{ parameters.sonarExclusions }}

- task: Maven@4
  displayName: 'Build'
  inputs:
    mavenPomFile: ${{ parameters.pomFile }}
    goals: 'clean install'
    publishJUnitResults: false
    checkStyleRunAnalysis: false
    pmdRunAnalysis: false
    findBugsRunAnalysis: false
    spotBugsRunAnalysis: false
    sonarQubeRunAnalysis: false

- task: SonarCloudPublish@1
  displayName: 'Publish Quality Gate Result'
  continueOnError: true
  inputs:
    pollingTimeoutSec: '120'

- task: ms-omex.prmetrics.prmetrics.PRMetrics@1
  displayName: 'PR Metrics'
  inputs:
    BaseSize: 200
    GrowthRate: 2.0
    TestFactor: 0.7
    FileMatchingPatterns: |
      **/*
      !Ignore.cs
    CodeFileExtensions: |
      cs
      ps1
  continueOnError: true       
  env:
    PR_METRICS_ACCESS_TOKEN: $(repotoken) 
